version: '3'

services:
  elasticsearch:
    image: docker.io/library/elasticsearch:8.12.2
    container_name: ids-elasticsearch
    restart: never
    # "If --memory-swap is set to the same value as --memory, and --memory is set to a positive integer, the container doesn't have access to swap"
    # https://docs.docker.com/config/containers/resource_constraints/#prevent-a-container-from-using-swap
    mem_limit: 8g
    memswap_limit: 8g
    environment:
      - discovery.type='single-node'
      - xpack.security.enabled='false'
    volumes:
      - ./data:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - ids

  kibana:
    image: docker.io/library/kibana:8.12.2
    container_name: ids-kibana
    restart: unless-stopped
    environment:
      - output.elasticsearch.hosts=["http://elasticsearch:9200"]
      - xpack.reporting.encryptionKey=${ENCRYPTION_KEY}
      - xpack.security.encryptionKey=${ENCRYPTION_KEY}
    ports:
      - 5601:5601
    networks:
      - ids

  filebeat:
    image: docker.io/elastic/filebeat:8.12.2
    container_name: ids-filebeat
    restart: unless-stopped
    environment:
      - output.elasticsearch.hosts=["http://elasticsearch:9200"]
      - setup.kibana.host=["kibana:5601"]
    # ports:
      # - :9200
    networks:
      - ids

networks:
  ids:
    external: false
    name: ids
